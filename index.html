<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FITNESS</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Helvetica Neue"', 'Helvetica', 'Arial', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                    },
                    colors: {
                        brand: {
                            base: '#F5F2EB',       /* Main Background */
                            surface: '#EBE6DD',    /* Secondary/Hover */
                            line: '#D4CDC1',       /* Borders/Grid Lines */
                            text: '#3A352F',       /* Primary Text */
                            muted: '#8C857B',      /* Secondary Text */
                            accent: '#A4907C',     /* Accents */
                            forest: '#1F3A2C',     /* Dark Interactive Green */
                        },
                        rust: { DEFAULT: '#C86A58' },
                        brass: '#C29A5B',
                        slate: '#5B7B8C',
                        forest: { 500: '#4A6B56', 700: '#2C4F3B' }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F5F2EB;
            color: #3A352F;
            /* Subtle organic noise texture */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
            -webkit-font-smoothing: antialiased;
        }

        /* Hard shadow for main container (Industrial Look) */
        .industrial-shadow {
            box-shadow: 8px 8px 0px 0px rgba(58,53,47,0.05);
        }

        .reveal-up {
            opacity: 0;
            animation: revealUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            transform: translateY(20px);
        }
        @keyframes revealUp { to { opacity: 1; transform: translateY(0); } }

        /* Custom Scrollbar for Day Selector */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Remove default input styling */
        input:focus, select:focus, textarea:focus { outline: none; box-shadow: none; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        .loader {
            border: 2px solid #D4CDC1;
            border-top: 2px solid #3A352F;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4 md:p-8 pt-6 relative selection:bg-brand-forest selection:text-brand-base">

    <!-- Header -->
    <div class="w-full max-w-2xl mx-auto mb-6 flex justify-between items-end reveal-up">
        <div>
            <h1 class="text-2xl md:text-3xl font-medium tracking-tight text-brand-text">FITNESS</h1>
            <p class="font-mono text-[10px] tracking-[0.2em] text-brand-muted uppercase mt-1" id="currentDate">LOADING DATE...</p>
        </div>
        
        <!-- Action Toolbar -->
        <div class="flex items-center gap-4 mb-1">
            <button onclick="openCalcModal()" class="text-brand-muted hover:text-brand-text transition-colors" title="Plate Calculator">
                <i data-lucide="calculator" width="18" height="18"></i>
            </button>
            <button onclick="openStatsModal()" class="text-brand-muted hover:text-brand-rust transition-colors" title="Consistency">
                <i data-lucide="heart" width="18" height="18"></i>
            </button>
            <button onclick="openKeyModal()" class="text-brand-muted hover:text-brand-text transition-colors" title="Sync Settings">
                <i data-lucide="arrow-left-right" width="18" height="18"></i>
            </button>
            <div class="flex items-center gap-2">
                <span id="status-dot" class="w-2 h-2 rounded-full bg-brass animate-pulse"></span>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <main class="w-full max-w-2xl mx-auto reveal-up delay-100 flex-grow pb-20">
        
        <!-- Day Selector (Scrollable) -->
        <div class="bg-brand-base border-b border-brand-line mb-6 overflow-x-auto hide-scrollbar">
            <div class="flex gap-2 pb-2" id="daySelector">
                <!-- JS Injected Days -->
            </div>
        </div>

        <!-- Session Type Toggles (Mechanical Look) -->
        <div id="tabContainer" class="flex font-mono text-[10px] tracking-widest uppercase border border-brand-line bg-brand-surface w-full mb-6 industrial-shadow">
            <button onclick="setTab('AM')" id="tab-AM" class="flex-1 py-3 text-brand-muted hover:text-brand-text transition-colors border-r border-brand-line">AM Shred</button>
            <button onclick="setTab('PM')" id="tab-PM" class="flex-1 py-3 text-brand-muted hover:text-brand-text transition-colors border-r border-brand-line">PM Build</button>
            <button onclick="setTab('FOOD')" id="tab-FOOD" class="flex-1 py-3 text-brand-muted hover:text-brand-text transition-colors">Fuel</button>
        </div>

        <!-- Content Grid Wrapper -->
        <div class="bg-brand-line border border-brand-line industrial-shadow flex flex-col gap-px" id="content">
            <!-- Loading State -->
            <div class="bg-brand-base p-12 flex flex-col items-center justify-center text-brand-muted">
                <div class="loader mb-4"></div>
                <p class="font-mono text-[10px] tracking-widest uppercase">Loading Protocol...</p>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="max-w-2xl mx-auto px-4 mt-8 text-center reveal-up delay-200 mb-8">
        <span class="font-mono text-[10px] tracking-[0.2em] text-brand-muted uppercase">
            Developed by Jose Torres
        </span>
    </footer>

    <!-- Modals -->
    
    <!-- Info/Meal Modal -->
    <div id="infoModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-brand-text/10 backdrop-blur-sm" onclick="closeModal('infoModal')"></div>
        <div class="relative bg-brand-base border border-brand-line w-full max-w-lg industrial-shadow p-6">
            <div class="flex justify-between items-start mb-4">
                <h3 id="modalTitle" class="font-mono text-[12px] tracking-[0.15em] text-brand-text uppercase font-bold">Details</h3>
                <button onclick="closeModal('infoModal')"><i data-lucide="x" width="16" class="text-brand-muted"></i></button>
            </div>
            <div id="modalBody" class="text-sm text-brand-text leading-relaxed whitespace-pre-line"></div>
        </div>
    </div>

    <!-- Key/Sync Modal -->
    <div id="keyModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-brand-text/10 backdrop-blur-sm" onclick="closeModal('keyModal')"></div>
        <div class="relative bg-brand-base border border-brand-line w-full max-w-md industrial-shadow">
            <div class="px-6 py-4 border-b border-brand-line bg-brand-surface flex justify-between items-center">
                <h3 class="font-mono text-[10px] tracking-[0.2em] text-brand-text uppercase flex items-center gap-2">
                    <i data-lucide="arrow-left-right" width="14" height="14"></i> Transfer Data
                </h3>
                <button onclick="closeModal('keyModal')"><i data-lucide="x" width="16" class="text-brand-muted"></i></button>
            </div>
            <div class="p-8">
                <p class="font-mono text-[10px] tracking-wide text-brand-muted uppercase mb-2">Export Data Key</p>
                <div class="bg-brand-surface p-3 border border-brand-line font-mono text-xs text-center text-brand-text mb-4 break-all max-h-24 overflow-hidden relative">
                    <div id="currentKeyDisplay" class="opacity-50 blur-[2px] hover:blur-none transition-all cursor-text">
                        Generating...
                    </div>
                </div>
                <button onclick="copyKey()" class="w-full bg-brand-text text-brand-base font-mono text-[10px] uppercase py-3 hover:bg-black transition-colors mb-6 flex items-center justify-center gap-2">
                    <i data-lucide="copy" width="12" height="12"></i> Copy Key to Clipboard
                </button>
                
                <div class="border-t border-brand-line pt-6">
                    <p class="font-mono text-[10px] tracking-wide text-brand-muted uppercase mb-2">Import Data Key</p>
                    <div class="flex items-center border-b border-brand-line py-1 mb-4">
                        <input type="text" id="recoverKeyInput" class="w-full bg-transparent text-brand-text font-mono text-sm outline-none placeholder-brand-muted/50" placeholder="PASTE KEY HERE">
                    </div>
                    <button onclick="recoverData()" class="w-full border border-brand-text text-brand-text font-mono text-[10px] uppercase py-3 hover:bg-brand-surface transition-colors">
                        Import & Overwrite
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Plate Calculator Modal -->
    <div id="calcModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-brand-text/10 backdrop-blur-sm" onclick="closeModal('calcModal')"></div>
        <div class="relative bg-brand-base border border-brand-line w-full max-w-md industrial-shadow">
             <div class="px-6 py-4 border-b border-brand-line bg-brand-surface flex justify-between items-center">
                <h3 class="font-mono text-[10px] tracking-[0.2em] text-brand-text uppercase flex items-center gap-2">
                    <i data-lucide="disc" width="14" height="14"></i> Plate Calc
                </h3>
                <button onclick="closeModal('calcModal')"><i data-lucide="x" width="16" class="text-brand-muted"></i></button>
            </div>
            <div class="p-8">
                <div class="mb-6">
                    <label class="block font-mono text-[10px] tracking-[0.15em] text-brand-muted uppercase mb-2">Target Weight (Lbs)</label>
                    <div class="flex items-center border-b border-brand-line focus-within:border-brand-forest transition-colors py-1">
                        <input type="number" id="targetWeight" oninput="calculatePlates()" 
                            class="w-full bg-transparent text-brand-text text-3xl font-medium outline-none font-mono placeholder-brand-muted/30" placeholder="225">
                    </div>
                </div>
                
                <div class="bg-brand-surface border border-brand-line p-4 min-h-[140px] flex flex-col items-center justify-center gap-4">
                    <div id="calcResult" class="font-mono text-xs uppercase text-brand-muted">Enter weight > 45</div>
                    <div id="platesVisual" class="flex gap-1 items-center justify-center h-20 w-full relative"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats/Consistency Modal -->
    <div id="statsModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-brand-text/10 backdrop-blur-sm" onclick="closeModal('statsModal')"></div>
        <div class="relative bg-brand-base border border-brand-line w-full max-w-lg industrial-shadow">
             <div class="px-6 py-4 border-b border-brand-line bg-brand-surface flex justify-between items-center">
                <h3 class="font-mono text-[10px] tracking-[0.2em] text-brand-text uppercase flex items-center gap-2">
                    <i data-lucide="activity" width="14" height="14"></i> Consistency (Last 7 Days)
                </h3>
                <button onclick="closeModal('statsModal')"><i data-lucide="x" width="16" class="text-brand-muted"></i></button>
            </div>
            <div class="p-8">
                <div id="statsGraph" class="w-full h-32 flex items-center justify-center">
                    <!-- SVG Injected Here -->
                </div>
                <div class="flex justify-between items-center mt-4 border-t border-brand-line pt-4">
                    <p class="font-mono text-[10px] uppercase text-brand-muted">Recent Activity</p>
                    <div class="flex items-center gap-4 font-mono text-[10px] uppercase text-brand-text">
                        <span class="flex items-center gap-1"><span class="w-2 h-2 bg-brand-line rounded-sm opacity-30"></span> Rest</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 bg-forest-500 rounded-sm"></span> Active</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-brand-text text-brand-base px-6 py-3 rounded-none font-mono text-[10px] uppercase tracking-widest transition-opacity duration-300 opacity-0 pointer-events-none industrial-shadow z-50">
        Changes Saved
    </div>

    <script>
        // --- APP STATE ---
        let appData = { workouts: {}, meals: {} };
        const LOCAL_STORAGE_KEY = 'recomp_offline_data';

        // --- DATA CONSTANTS ---
        const workoutData = {
            'Monday': {
                AM: [
                    { id: 'm_am_1', name: 'Incline Walk (Zone 2)', target: '45 mins', type: 'cardio' },
                    { id: 'm_am_2', name: 'Hanging Leg Raises', target: '3 sets to Failure', type: 'reps_only' },
                    { id: 'm_am_3', name: 'Bicycle Crunches', target: '3 x 50 reps', type: 'reps_only' },
                    { id: 'm_am_4', name: 'Plank', target: '3 x 60s', type: 'duration' }
                ],
                PM: [
                    { id: 'm_pm_1', name: 'Barbell Bench Press', target: '3 x 6-8' },
                    { id: 'm_pm_2', name: 'Overhead Press', target: '3 x 8-10' },
                    { id: 'm_pm_3', name: 'Incline DB Press', target: '3 x 10-12' },
                    { id: 'm_pm_4', name: 'DB Lateral Raises', target: '3 x 12-15' },
                    { id: 'm_pm_5', name: 'Tricep Pushdowns', target: '3 x 12-15' }
                ]
            },
            'Tuesday': {
                AM: [
                    { id: 't_am_1', name: 'Incline Walk (Zone 2)', target: '45 mins', type: 'cardio' },
                    { id: 't_am_2', name: 'Cable Crunches', target: '3 x 15-20' },
                    { id: 't_am_3', name: 'Ab Wheel Rollouts', target: '3 x 10-15', type: 'reps_only' }
                ],
                PM: [
                    { id: 't_pm_1', name: 'Barbell Rows', target: '3 x 6-8' },
                    { id: 't_pm_2', name: 'Weighted Pull-Ups', target: '3 x 8-10' },
                    { id: 't_pm_3', name: 'Seated Cable Rows', target: '3 x 10-12' },
                    { id: 't_pm_4', name: 'Face Pulls', target: '3 x 15-20' },
                    { id: 't_pm_5', name: 'Barbell Bicep Curls', target: '3 x 10-12' }
                ]
            },
            'Wednesday': {
                AM: [
                    { id: 'w_am_1', name: 'Incline Walk (Zone 2)', target: '45 mins', type: 'cardio' },
                    { id: 'w_am_2', name: 'Plank', target: '3 x Max Time', type: 'duration' }
                ],
                PM: [
                    { id: 'w_pm_1', name: 'Barbell Squats', target: '3 x 6-8' },
                    { id: 'w_pm_2', name: 'Romanian Deadlifts', target: '3 x 8-10' },
                    { id: 'w_pm_3', name: 'Leg Press', target: '3 x 12-15' },
                    { id: 'w_pm_4', name: 'Leg Curls', target: '3 x 12-15' },
                    { id: 'w_pm_5', name: 'Calf Raises', target: '4 x 15-20' }
                ]
            },
            'Thursday': {
                AM: [
                    { id: 'th_am_1', name: 'Incline Walk (Zone 2)', target: '45 mins', type: 'cardio' },
                    { id: 'th_am_2', name: 'Hanging Leg Raises', target: '3 x Failure', type: 'reps_only' },
                    { id: 'th_am_3', name: 'Bicycle Crunches', target: '3 x 50', type: 'reps_only' }
                ],
                PM: [
                    { id: 'th_pm_1', name: 'Incline BB Bench', target: '3 x 8-10' },
                    { id: 'th_pm_2', name: 'DB Shoulder Press', target: '3 x 10-12' },
                    { id: 'th_pm_3', name: 'Cable Crossovers', target: '3 x 12-15' },
                    { id: 'th_pm_4', name: 'Cable Lateral Raises', target: '3 x 15-20' },
                    { id: 'th_pm_5', name: 'Overhead Tri Ext', target: '3 x 12-15' }
                ]
            },
            'Friday': {
                AM: [
                    { id: 'f_am_1', name: 'Incline Walk (Zone 2)', target: '45 mins', type: 'cardio' },
                    { id: 'f_am_2', name: 'Cable Crunches', target: '3 x 15-20' }
                ],
                PM: [
                    { id: 'f_pm_1', name: 'Lat Pulldowns', target: '3 x 10-12' },
                    { id: 'f_pm_2', name: 'Single-Arm DB Row', target: '3 x 10-12' },
                    { id: 'f_pm_3', name: 'Straight-Arm Pulldown', target: '3 x 12-15' },
                    { id: 'f_pm_4', name: 'Rear Delt Flys', target: '3 x 15-20' },
                    { id: 'f_pm_5', name: 'Hammer Curls', target: '3 x 10-12' }
                ]
            },
            'Saturday': {
                AM: [
                    { id: 's_am_1', name: 'Incline Walk (Zone 2)', target: '45 mins', type: 'cardio' },
                    { id: 's_am_2', name: 'Plank', target: '3 x Max Time', type: 'duration' }
                ],
                PM: [
                    { id: 's_pm_1', name: 'Deadlifts', target: '3 x 5-8' },
                    { id: 's_pm_2', name: 'Walking Lunges', target: '3 x 10-12' },
                    { id: 's_pm_3', name: 'Leg Extensions', target: '3 x 15-20' },
                    { id: 's_pm_4', name: 'Glute Bridges', target: '3 x 12-15' },
                    { id: 's_pm_5', name: 'Seated Calf Raises', target: '4 x 15-20' }
                ]
            },
            'Sunday': {
                AM: [], 
                PM: [] 
            }
        };

        const meals = [
            { id: 'm1', name: 'Breakfast', desc: 'Oats, Whey, Berries, Almond Butter', details: '• 1 cup Oatmeal (cooked with water)\n• 1 scoop Whey Protein\n• 1/2 cup Blueberries\n• 1 tbsp Almond Butter' },
            { id: 'm2', name: 'Lunch', desc: 'Chicken, Brown Rice, Broccoli', details: '• 6 oz Grilled Chicken Breast\n• 1 cup Cooked Brown Rice\n• 2 cups Steamed Broccoli' },
            { id: 'm3', name: 'Pre-Workout', desc: 'Banana, Whey Isolate', details: '• 1 Medium Banana\n• 1 scoop Whey Protein Isolate (water)' },
            { id: 'm4', name: 'Post-Workout', desc: 'Lean Beef/Salmon, Sweet Potato', details: '• 6 oz Lean Ground Beef (93%) OR Salmon\n• 1 Medium Baked Sweet Potato\n• 2 cups Green Beans or Asparagus' },
            { id: 'm5', name: 'Before Bed', desc: 'Greek Yogurt, Walnuts', details: '• 1 cup Plain Greek Yogurt (Non-fat)\n• 1/4 cup Walnuts' }
        ];

        // --- UI STATE ---
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const shortDays = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
        let currentDayIdx = new Date().getDay();
        let selectedDay = days[currentDayIdx];
        let activeTab = 'PM'; 
        if (new Date().getHours() < 12) activeTab = 'AM';

        // --- INIT ---
        function init() {
            renderDaySelector();
            updateDateHeader();
            updateTabVisibility(); 
            
            // Load Local Data
            try {
                const local = localStorage.getItem(LOCAL_STORAGE_KEY);
                if(local) {
                    appData = JSON.parse(local);
                }
            } catch (e) {
                console.error("Error loading local data", e);
            }
            
            document.getElementById('status-dot').className = 'w-2 h-2 rounded-full bg-brass';
            renderContent();
        }

        // --- CORE UI FUNCTIONS ---
        
        function updateDateHeader() {
            const today = new Date();
            const options = { weekday: 'long', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').innerText = today.toLocaleDateString('en-US', options);
        }

        function renderDaySelector() {
            const selector = document.getElementById('daySelector');
            selector.innerHTML = '';
            days.forEach((day, idx) => {
                const isSelected = day === selectedDay;
                const btn = document.createElement('button');
                btn.className = `
                    px-4 py-2 font-mono text-[10px] uppercase tracking-widest transition-all rounded-full border 
                    ${isSelected 
                        ? 'bg-brand-forest text-brand-base border-brand-forest' 
                        : 'bg-brand-base text-brand-muted border-brand-line hover:border-brand-accent'}
                `;
                btn.innerText = shortDays[idx];
                btn.onclick = () => {
                    selectedDay = day;
                    renderDaySelector();
                    updateTabVisibility(); 
                    renderContent();
                };
                selector.appendChild(btn);
            });
        }

        function updateTabVisibility() {
            const amBtn = document.getElementById('tab-AM');
            const pmBtn = document.getElementById('tab-PM');
            const foodBtn = document.getElementById('tab-FOOD');

            if (selectedDay === 'Sunday') {
                amBtn.style.display = 'none';
                pmBtn.style.display = 'none';
                foodBtn.classList.remove('border-l'); 
                setTab('FOOD');
            } else {
                amBtn.style.display = 'block';
                pmBtn.style.display = 'block';
            }
        }

        window.setTab = function(tabName) {
            activeTab = tabName;
            
            ['AM', 'PM', 'FOOD'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                btn.classList.remove('bg-brand-base', 'text-brand-text');
                btn.classList.add('text-brand-muted');
            });

            const activeBtn = document.getElementById(`tab-${tabName}`);
            activeBtn.classList.remove('text-brand-muted');
            activeBtn.classList.add('bg-brand-base', 'text-brand-text');
            
            renderContent();
        }

        function renderContent() {
            const content = document.getElementById('content');
            content.innerHTML = '';

            // --- MEAL TAB ---
            if (activeTab === 'FOOD') {
                const dateKey = getTodayDateStr();
                const todaysMeals = appData.meals[dateKey] || {};
                
                if (meals.length === 0) {
                     content.innerHTML = emptyStateHTML('No Meals Configured');
                     return;
                }

                meals.forEach(meal => {
                    const isChecked = todaysMeals[meal.id] === true;
                    
                    const div = document.createElement('div');
                    div.className = `bg-brand-base p-6 flex items-start gap-4 transition-colors hover:bg-brand-surface cursor-pointer group`;
                    div.onclick = (e) => { 
                        if(!e.target.closest('button')) toggleMeal(meal.id); 
                    };

                    div.innerHTML = `
                        <div class="mt-1 w-5 h-5 border border-brand-muted flex items-center justify-center transition-colors ${isChecked ? 'bg-brand-forest border-brand-forest' : ''}">
                            ${isChecked ? '<i data-lucide="check" class="text-white w-3 h-3"></i>' : ''}
                        </div>
                        <div class="flex-1">
                            <h4 class="font-medium text-brand-text ${isChecked ? 'line-through opacity-50' : ''}">${meal.name}</h4>
                            <p class="text-sm text-brand-muted mt-1 font-mono leading-relaxed ${isChecked ? 'line-through opacity-50' : ''}">${meal.desc}</p>
                        </div>
                        <button onclick="openMealInfo(event, '${meal.id}')" class="w-12 h-12 flex items-center justify-center -mt-2 -mr-2 text-brand-muted hover:text-brand-text hover:bg-brand-line/30 rounded-full transition-colors">
                            <i data-lucide="info" width="20" height="20"></i>
                        </button>
                    `;
                    content.appendChild(div);
                });
                lucide.createIcons();
                return;
            }

            // --- WORKOUT TAB ---
            const sessionExercises = workoutData[selectedDay] ? workoutData[selectedDay][activeTab] : [];
            
            if (!sessionExercises || sessionExercises.length === 0) {
                content.innerHTML = `
                    <div class="bg-brand-base p-12 flex flex-col items-center justify-center text-brand-muted">
                        <i data-lucide="coffee" width="32" height="32" class="mb-4 opacity-50"></i>
                        <p class="font-mono text-[10px] tracking-widest uppercase">Rest Day</p>
                    </div>`;
                lucide.createIcons();
                return;
            }

            sessionExercises.forEach(ex => {
                const key = getStorageKey(selectedDay, ex.id);
                const todayData = appData.workouts[key] || {};
                
                const history = getHistory(ex.name);
                const numSets = getSetCount(ex.target, ex.type);

                // History Pill
                let historyHTML = '';
                if (history) {
                    let text = '';
                    if (ex.type === 'cardio') {
                        const h = history.sets?.[0] || {};
                        text = `${h.t || '-'}m / ${h.w || '-'}spd / ${h.r || '-'}inc`;
                    }
                    else if (ex.type === 'duration' || ex.type === 'reps_only') text = `${(history.sets||[]).map(s=>s.r).join(', ')}`;
                    else text = `${(history.sets||[]).map(s => s.w ? `${s.w}x${s.r}` : '-').join(', ')}`;
                    
                    let ratingIndicator = '';
                    if (history.rating) {
                        let dotColor = history.rating === 'easy' ? 'bg-forest-500' : (history.rating === 'med' ? 'bg-brass' : 'bg-rust');
                        let ratingLabel = history.rating.toUpperCase();
                        ratingIndicator = `<div class="flex items-center gap-1.5 ml-2 pl-2 border-l border-brand-line"><span class="w-1.5 h-1.5 rounded-full ${dotColor}"></span><span>${ratingLabel}</span></div>`;
                    }

                    historyHTML = `
                        <div class="inline-flex items-center px-2 py-1 bg-brand-surface border border-brand-line text-[10px] font-mono uppercase text-brand-muted mb-4">
                            <div class="flex items-center gap-1.5"><i data-lucide="history" width="10" height="10"></i> <span>Last: ${text}</span></div>
                            ${ratingIndicator}
                        </div>
                    `;
                }

                // Sets Generation
                let setsHTML = `<div class="flex flex-col gap-2 mb-4" id="sets-${ex.id}">`;
                for(let i=0; i<numSets; i++) {
                    const setNum = i + 1;
                    const setData = (todayData.sets && todayData.sets[i]) ? todayData.sets[i] : {w:'', r:'', t:''};
                    const touchedAttr = setData.w || setData.r || setData.t ? 'data-touched="true"' : 'data-touched="false"';
                    
                    const inputBase = "bg-transparent border-b border-brand-line focus:border-brand-forest text-center font-mono text-sm py-1 outline-none transition-colors w-full text-brand-text placeholder-brand-muted/30";

                    let rowContent = '';
                    
                    if (ex.type === 'cardio') {
                        rowContent = `
                            <input type="number" class="${inputBase}" placeholder="Min" value="${setData.t || ''}" onchange="saveSet('${ex.id}', ${i}, 't', this.value)">
                            <input type="number" class="${inputBase}" placeholder="Spd" value="${setData.w || ''}" onchange="saveSet('${ex.id}', ${i}, 'w', this.value)">
                            <input type="number" class="${inputBase}" placeholder="Inc" value="${setData.r || ''}" onchange="saveSet('${ex.id}', ${i}, 'r', this.value)">
                        `;
                    } else if (ex.type === 'duration') {
                         const timeObj = parseDuration(setData.r);
                         rowContent = `
                            <div class="flex gap-2 w-full" id="dur-${ex.id}-${i}" ${touchedAttr}>
                                <input type="number" class="${inputBase} dur-min" placeholder="Min" value="${timeObj.m}" oninput="handleDurationInput('${ex.id}', ${i}, 'm', this.value)">
                                <span class="text-brand-muted">:</span>
                                <input type="number" class="${inputBase} dur-sec" placeholder="Sec" value="${timeObj.s}" oninput="handleDurationInput('${ex.id}', ${i}, 's', this.value)">
                            </div>
                         `;
                    } else if (ex.type === 'reps_only') {
                         rowContent = `
                            <input type="number" class="${inputBase}" placeholder="Reps" value="${setData.r}" onchange="saveSet('${ex.id}', ${i}, 'r', this.value)">
                         `;
                    } else {
                        const weightEvent = i === 0 ? `onchange="handleFirstSetAutofill('${ex.id}', 'w', this.value)"` : `onchange="saveSet('${ex.id}', ${i}, 'w', this.value); markTouched('${ex.id}', ${i})"`;
                        rowContent = `
                            <input type="number" class="${inputBase} autofill-target" id="w-${ex.id}-${i}" placeholder="Lbs" value="${setData.w}" ${touchedAttr} ${weightEvent}>
                            <input type="number" class="${inputBase}" placeholder="Reps" value="${setData.r}" onchange="saveSet('${ex.id}', ${i}, 'r', this.value)">
                        `;
                    }

                    // Adjust column layout based on type
                    let gridClass = ex.type === 'cardio' ? 'grid-cols-3 gap-2' : (ex.type === undefined ? 'grid-cols-2 gap-4' : 'grid-cols-1');

                    setsHTML += `
                        <div class="grid grid-cols-[40px_1fr] gap-4 items-center">
                            <span class="font-mono text-[10px] text-brand-muted text-right pr-2 border-r border-brand-line">0${setNum}</span>
                            <div class="grid ${gridClass}">
                                ${rowContent}
                            </div>
                        </div>
                    `;
                }
                setsHTML += '</div>';

                // Rating Dots
                const r = todayData.rating;
                const ratingHTML = `
                    <div class="flex justify-end gap-2 mt-2">
                        <button onclick="saveRating('${ex.id}', 'easy')" class="w-6 h-6 rounded-full border border-brand-line flex items-center justify-center transition-all ${r==='easy' ? 'bg-forest-500 border-forest-500 text-white' : 'hover:bg-brand-surface'}">
                            <span class="block w-2 h-2 rounded-full ${r==='easy' ? 'bg-white' : 'bg-forest-500'}"></span>
                        </button>
                        <button onclick="saveRating('${ex.id}', 'med')" class="w-6 h-6 rounded-full border border-brand-line flex items-center justify-center transition-all ${r==='med' ? 'bg-brass border-brass text-white' : 'hover:bg-brand-surface'}">
                             <span class="block w-2 h-2 rounded-full ${r==='med' ? 'bg-white' : 'bg-brass'}"></span>
                        </button>
                        <button onclick="saveRating('${ex.id}', 'hard')" class="w-6 h-6 rounded-full border border-brand-line flex items-center justify-center transition-all ${r==='hard' ? 'bg-rust border-rust text-white' : 'hover:bg-brand-surface'}">
                             <span class="block w-2 h-2 rounded-full ${r==='hard' ? 'bg-white' : 'bg-rust'}"></span>
                        </button>
                    </div>
                `;

                // Main Card Construction
                const card = document.createElement('div');
                card.className = 'bg-brand-base p-6 md:p-8';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-medium text-brand-text leading-tight cursor-pointer hover:underline decoration-brand-muted underline-offset-4" onclick="openGoogleSearch('${ex.name.replace(/'/g, "\\'")}')">${ex.name}</h3>
                            <p class="font-mono text-[10px] tracking-wider text-brand-muted uppercase mt-1">${ex.target}</p>
                        </div>
                    </div>
                    ${historyHTML}
                    ${setsHTML}
                    ${ratingHTML}
                `;
                content.appendChild(card);
            });
            lucide.createIcons();
        }

        // --- HELPERS & LOGIC ---
        
        function getTodayDateStr() { return new Date().toISOString().split('T')[0]; }
        function getStorageKey(day, id) { return `${getTodayDateStr()}_${id}`; }
        
        function getSetCount(targetStr, type) {
            if(type === 'cardio') return 1;
            const match = targetStr.match(/^(\d+)/);
            return (match && match[1]) ? parseInt(match[1]) : 1;
        }

        function parseDuration(val) {
            if (!val) return { m: '', s: '' };
            if (!val.toString().includes(':')) {
                const secs = parseInt(val);
                if (!isNaN(secs)) return { m: Math.floor(secs / 60) || '', s: (secs % 60).toString().padStart(2, '0') };
                return { m: '', s: '' };
            }
            const parts = val.split(':');
            return { m: parts[0], s: parts[1] };
        }

        // Save Functions
        function saveData() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appData));
            showToast();
        }

        window.saveSet = function(exId, setIndex, field, value) {
            const key = getStorageKey(selectedDay, exId);
            let data = appData.workouts[key] ? JSON.parse(JSON.stringify(appData.workouts[key])) : {};
            if(!data.sets) data.sets = [];
            if(!data.sets[setIndex]) data.sets[setIndex] = {w:'', r:'', t:''};
            data.sets[setIndex][field] = value;
            data.timestamp = Date.now();
            data.date = getTodayDateStr();
            data.exerciseId = exId;
            appData.workouts[key] = data;
            saveData();
        }

        window.saveRating = function(exId, rating) {
            const key = getStorageKey(selectedDay, exId);
            let data = appData.workouts[key] ? JSON.parse(JSON.stringify(appData.workouts[key])) : {};
            data.rating = rating;
            data.date = getTodayDateStr();
            data.exerciseId = exId;
            appData.workouts[key] = data;
            renderContent(); 
            saveData();
        }

        window.toggleMeal = function(mealId) {
            const dateKey = getTodayDateStr();
            let data = appData.meals[dateKey] ? JSON.parse(JSON.stringify(appData.meals[dateKey])) : {};
            data[mealId] = !data[mealId];
            appData.meals[dateKey] = data;
            renderContent();
            saveData();
        }

        // Auto-fill Logic
        window.handleFirstSetAutofill = function(exId, field, value) {
            saveSet(exId, 0, field, value);
            const container = document.getElementById(`sets-${exId}`);
            const inputs = container.querySelectorAll('.autofill-target');
            for (let i = 1; i < inputs.length; i++) {
                const input = inputs[i];
                if (input.getAttribute('data-touched') !== 'true') {
                    input.value = value;
                    saveSet(exId, i, field, value);
                }
            }
        }
        
        window.markTouched = function(exId, index) {
            const el = document.getElementById(`w-${exId}-${index}`);
            if(el) el.setAttribute('data-touched', 'true');
        }

        window.handleDurationInput = function(exId, index, type, val) {
            const container = document.getElementById(`dur-${exId}-${index}`);
            container.setAttribute('data-touched', 'true');
            const m = container.querySelector('.dur-min').value;
            const s = container.querySelector('.dur-sec').value;
            const combined = `${m || '0'}:${s.toString().padStart(2, '0')}`;
            saveSet(exId, index, 'r', combined);
        }

        // Modals
        window.openCalcModal = () => document.getElementById('calcModal').classList.remove('hidden');
        
        window.openKeyModal = () => {
            document.getElementById('keyModal').classList.remove('hidden');
            try {
                const dataString = btoa(JSON.stringify(appData));
                document.getElementById('currentKeyDisplay').innerText = dataString;
            } catch(e) {
                document.getElementById('currentKeyDisplay').innerText = "Error generating key.";
            }
        };

        window.openMealInfo = (e, id) => {
            e.stopPropagation();
            const meal = meals.find(m => m.id === id);
            document.getElementById('modalTitle').innerText = meal.name;
            document.getElementById('modalBody').innerText = meal.details;
            document.getElementById('infoModal').classList.remove('hidden');
        };
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        
        window.openGoogleSearch = (term) => window.open('https://www.google.com/search?q=' + encodeURIComponent(term), '_blank');

        // Utils
        window.copyKey = () => {
            const text = document.getElementById('currentKeyDisplay').innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert('Key Copied! Paste this code in the other device to restore your data.');
            });
        };

        window.recoverData = () => {
            const input = document.getElementById('recoverKeyInput').value.trim();
            if(input.length < 10) {
                alert("Invalid Key (Too Short)");
                return;
            }
            
            try {
                const parsed = JSON.parse(atob(input));
                if(parsed && typeof parsed === 'object') {
                    if(confirm("This will overwrite your current data. Continue?")) {
                        appData = parsed;
                        saveData();
                        alert("Data Imported Successfully!");
                        window.location.reload();
                    }
                } else {
                    throw new Error("Invalid format");
                }
            } catch(e) { 
                alert("Invalid Backup Key. Please ensure you copied the entire string."); 
                console.error(e);
            }
        };
        
        window.calculatePlates = () => {
            const val = parseInt(document.getElementById('targetWeight').value);
            const resultEl = document.getElementById('calcResult');
            const visualEl = document.getElementById('platesVisual');
            
            if(!val || val < 45) {
                resultEl.innerText = "Minimum weight is 45lbs";
                visualEl.innerHTML = '';
                return;
            }
            
            let weight = (val - 45) / 2;
            const plates = [45, 35, 25, 10, 5, 2.5];
            let plateHtml = '';
            let summary = [];
            
            plates.forEach(p => {
                while(weight >= p) {
                    weight -= p;
                    summary.push(p);
                    
                    let h = 'h-24', w = 'w-4', c = 'bg-brand-text';
                    
                    if(p===45) { h='h-24'; c='bg-brand-text'; }
                    else if(p===35) { h='h-20'; c='bg-brand-text/90'; }
                    else if(p===25) { h='h-16'; c='bg-brand-text/80'; }
                    else if(p===10) { h='h-12'; c='bg-brand-muted'; }
                    else if(p===5)  { h='h-8';  c='bg-brass'; }
                    else if(p===2.5){ h='h-6';  c='bg-rust'; }
                    
                    plateHtml += `<div class="${h} ${w} ${c} rounded-[2px] shadow-sm flex-shrink-0 relative z-10"></div>`;
                }
            });
            
            resultEl.innerText = `${summary.length} plates per side`;
            
            const barHtml = `<div class="absolute w-full h-3 bg-brand-line rounded-full z-0 top-1/2 -translate-y-1/2"></div>`;
            
            visualEl.className = "relative flex items-center justify-center gap-1 h-32 w-full overflow-x-auto hide-scrollbar px-4";
            visualEl.innerHTML = barHtml + `<div class="flex items-center gap-1.5 z-10 relative">${plateHtml}</div>`;
        };

        // NEW: Match history by Exact Exercise Name instead of ID 
        // This links identical workouts across different days seamlessly 
        function getHistory(exName) {
            const todayStr = getTodayDateStr();
            const matches = [];

            // 1. Gather all unique IDs that correspond to this exercise name
            const matchingIds = new Set();
            Object.values(workoutData).forEach(day => {
                if (day.AM) day.AM.forEach(ex => { if(ex.name === exName) matchingIds.add(ex.id) });
                if (day.PM) day.PM.forEach(ex => { if(ex.name === exName) matchingIds.add(ex.id) });
            });

            // 2. Query stored data for any of those IDs
            Object.values(appData.workouts).forEach(d => {
                if (matchingIds.has(d.exerciseId) && d.date !== todayStr) {
                    matches.push(d);
                }
            });

            return matches.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
        }

        function showToast() {
            const t = document.getElementById('toast');
            t.classList.remove('opacity-0');
            setTimeout(() => t.classList.add('opacity-0'), 1500);
        }

        window.openStatsModal = () => {
            document.getElementById('statsModal').classList.remove('hidden');
            renderStatsGraph();
        };

        function renderStatsGraph() {
            const container = document.getElementById('statsGraph');
            const today = new Date();
            const daysToShow = 7;
            
            const activeDates = new Set();
            
            Object.values(appData.workouts).forEach(w => activeDates.add(w.date));
            Object.keys(appData.meals).forEach(date => {
                 const mData = appData.meals[date];
                 if(Object.values(mData).some(v => v === true)) activeDates.add(date);
            });

            const width = 320;
            const height = 80;
            const itemRadius = 12;
            const gap = 24; 
            
            const step = 40; 
            const startX = (width - (step * (daysToShow - 1))) / 2;
            
            let svghtml = `<svg width="100%" height="100%" viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet">`;
            
            svghtml += `<line x1="${startX}" y1="30" x2="${startX + (step * (daysToShow - 1))}" y2="30" stroke="#D4CDC1" stroke-width="1" stroke-linecap="round" opacity="0.5" />`;

            for(let i=daysToShow-1; i>=0; i--) {
                const d = new Date();
                d.setDate(today.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                const dayName = d.toLocaleDateString('en-US', { weekday: 'narrow' }); 
                const isActive = activeDates.has(dateStr);
                const isToday = i === 0;

                const index = (daysToShow - 1) - i; 
                const cx = startX + (index * step);
                const cy = 30;

                const fillColor = isActive ? '#4A6B56' : '#F5F2EB'; 
                const strokeColor = isActive ? '#4A6B56' : '#D4CDC1'; 
                
                if (isActive) {
                    svghtml += `<circle cx="${cx}" cy="${cy}" r="${itemRadius}" fill="${fillColor}" />`;
                } else {
                    svghtml += `<circle cx="${cx}" cy="${cy}" r="${itemRadius}" fill="${fillColor}" stroke="${strokeColor}" stroke-width="2" />`;
                }
                
                if(isToday) {
                     svghtml += `<circle cx="${cx}" cy="${cy}" r="${itemRadius + 5}" fill="none" stroke="#C29A5B" stroke-width="1.5" stroke-dasharray="2 2" />`;
                }

                const textColor = isToday ? '#3A352F' : '#8C857B';
                const fontWeight = isToday ? 'bold' : 'normal';
                svghtml += `<text x="${cx}" y="${cy + 30}" font-family="monospace" font-size="10" text-anchor="middle" fill="${textColor}" font-weight="${fontWeight}">${dayName}</text>`;
            }
            
            svghtml += `</svg>`;
            container.innerHTML = svghtml;
        }

        // Start
        init();

    </script>
</body>
</html>


