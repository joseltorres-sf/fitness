<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- CRITICAL FOR IOS HOME SCREEN DARK MODE -->
    <meta name="color-scheme" content="light dark">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Meta Theme Colors for Mobile Browsers -->
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#F5F2EB">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#151413">
    
    <title>FITNESS</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* CSS Variables for Light/Dark Mode Switching */
        :root {
            color-scheme: light dark; /* Tells the engine to support both */
            --brand-base: #F5F2EB;       
            --brand-surface: #EBE6DD;    
            --brand-line: #D4CDC1;       
            --brand-text: #3A352F;       
            --brand-muted: #8C857B;      
            --brand-accent: #A4907C;     
            --brand-forest: #1F3A2C;     
            --shadow-color: rgba(58,53,47,0.05);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --brand-base: #151413;       
                --brand-surface: #211F1D;    
                --brand-line: #36332E;       
                --brand-text: #E8E3DB;       
                --brand-muted: #948F87;      
                --brand-accent: #A4907C;     
                --brand-forest: #8FA696;     
                --shadow-color: rgba(0, 0, 0, 0.4);
            }
        }

        /* Set background on HTML and Body to prevent "white flashes" on iOS */
        html, body {
            background-color: var(--brand-base);
            color: var(--brand-text);
        }

        body {
            /* Subtle organic noise texture */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
            -webkit-font-smoothing: antialiased;
        }

        .industrial-shadow {
            box-shadow: 8px 8px 0px 0px var(--shadow-color);
        }

        .reveal-up {
            opacity: 0;
            animation: revealUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            transform: translateY(20px);
        }
        @keyframes revealUp { to { opacity: 1; transform: translateY(0); } }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        input:focus, select:focus, textarea:focus { outline: none; box-shadow: none; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        .loader {
            border: 2px solid var(--brand-line);
            border-top: 2px solid var(--brand-text);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Helvetica Neue"', 'Helvetica', 'Arial', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                    },
                    colors: {
                        brand: {
                            base: 'var(--brand-base)',
                            surface: 'var(--brand-surface)',
                            line: 'var(--brand-line)',
                            text: 'var(--brand-text)',
                            muted: 'var(--brand-muted)',
                            accent: 'var(--brand-accent)',
                            forest: 'var(--brand-forest)',
                        },
                        rust: { DEFAULT: '#C86A58' },
                        brass: '#C29A5B',
                        slate: '#5B7B8C',
                        forest: { 500: '#4A6B56', 700: '#2C4F3B' }
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen flex flex-col p-4 md:p-8 pt-6 relative selection:bg-brand-forest selection:text-brand-base">

    <!-- Header -->
    <div class="w-full max-w-2xl mx-auto mb-6 flex justify-between items-end reveal-up">
        <div>
            <h1 class="text-2xl md:text-3xl font-medium tracking-tight text-brand-text">FITNESS</h1>
            <p class="font-mono text-[10px] tracking-[0.2em] text-brand-muted uppercase mt-1" id="currentDate">LOADING DATE...</p>
        </div>
        
        <!-- Action Toolbar -->
        <div class="flex items-center gap-4 mb-1">
            <button onclick="openCalcModal()" class="text-brand-muted hover:text-brand-text transition-colors" title="Plate Calculator">
                <i data-lucide="calculator" width="18" height="18"></i>
            </button>
            <button onclick="openStatsModal()" class="relative text-brand-muted hover:text-brand-rust transition-colors" title="Consistency">
                <i data-lucide="heart" width="18" height="18"></i>
                <span id="consistency-dot" class="absolute -top-1 -right-1 w-2 h-2 rounded-full opacity-0 transition-all duration-500 shadow-sm"></span>
            </button>
            <button onclick="openKeyModal()" class="text-brand-muted hover:text-brand-text transition-colors" title="Sync Settings">
                <i data-lucide="arrow-left-right" width="18" height="18"></i>
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <main class="w-full max-w-2xl mx-auto reveal-up delay-100 flex-grow pb-20">
        
        <!-- Day Selector (Scrollable) -->
        <div class="bg-brand-base border-b border-brand-line mb-6 overflow-x-auto hide-scrollbar">
            <div class="flex gap-2 pb-2" id="daySelector">
                <!-- JS Injected Days -->
            </div>
        </div>

        <!-- Session Type Toggles -->
        <div id="tabContainer" class="flex font-mono text-[10px] tracking-widest uppercase border border-brand-line bg-brand-surface w-full mb-6 industrial-shadow">
            <button onclick="setTab('AM')" id="tab-AM" class="relative flex-1 py-3 text-brand-muted hover:text-brand-text transition-colors border-r border-brand-line">
                AM Shred<span id="dot-AM" class="absolute top-2 right-2 w-1.5 h-1.5 rounded-full transition-all duration-500 opacity-0"></span>
            </button>
            <button onclick="setTab('PM')" id="tab-PM" class="relative flex-1 py-3 text-brand-muted hover:text-brand-text transition-colors border-r border-brand-line">
                PM Build<span id="dot-PM" class="absolute top-2 right-2 w-1.5 h-1.5 rounded-full transition-all duration-500 opacity-0"></span>
            </button>
            <button onclick="setTab('FOOD')" id="tab-FOOD" class="relative flex-1 py-3 text-brand-muted hover:text-brand-text transition-colors">
                Fuel<span id="dot-FOOD" class="absolute top-2 right-2 w-1.5 h-1.5 rounded-full transition-all duration-500 opacity-0"></span>
            </button>
        </div>

        <!-- Content Grid Wrapper -->
        <div class="bg-brand-line border border-brand-line industrial-shadow flex flex-col gap-px relative" id="content">
            <!-- Loading State -->
            <div class="bg-brand-base p-12 flex flex-col items-center justify-center text-brand-muted">
                <div class="loader mb-4"></div>
                <p class="font-mono text-[10px] tracking-widest uppercase">Loading Protocol...</p>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="max-w-2xl mx-auto px-4 mt-8 text-center reveal-up delay-200 mb-8">
        <span class="font-mono text-[10px] tracking-[0.2em] text-brand-muted uppercase">
            Developed by Jose Torres
        </span>
    </footer>

    <!-- Modals -->
    
    <!-- Info/Meal Modal -->
    <div id="infoModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal('infoModal')"></div>
        <div class="relative bg-brand-base border border-brand-line w-full max-w-lg industrial-shadow p-6">
            <div class="flex justify-between items-start mb-4">
                <h3 id="modalTitle" class="font-mono text-[12px] tracking-[0.15em] text-brand-text uppercase font-bold">Details</h3>
                <button onclick="closeModal('infoModal')"><i data-lucide="x" width="16" class="text-brand-muted"></i></button>
            </div>
            <div id="modalBody" class="text-sm text-brand-text leading-relaxed whitespace-pre-line"></div>
        </div>
    </div>

    <!-- Key/Sync Modal -->
    <div id="keyModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal('keyModal')"></div>
        <div class="relative bg-brand-base border border-brand-line w-full max-w-md industrial-shadow">
            <div class="px-6 py-4 border-b border-brand-line bg-brand-surface flex justify-between items-center">
                <h3 class="font-mono text-[10px] tracking-[0.2em] text-brand-text uppercase flex items-center gap-2">
                    <i data-lucide="arrow-left-right" width="14" height="14"></i> Transfer Data
                </h3>
                <button onclick="closeModal('keyModal')"><i data-lucide="x" width="16" class="text-brand-muted"></i></button>
            </div>
            <div class="p-8">
                <p class="font-mono text-[10px] tracking-wide text-brand-muted uppercase mb-2">Export Data Key</p>
                <div class="bg-brand-surface p-3 border border-brand-line font-mono text-xs text-center text-brand-text mb-4 break-all max-h-24 overflow-hidden relative">
                    <div id="currentKeyDisplay" class="opacity-50 blur-[2px] hover:blur-none transition-all cursor-text">
                        Generating...
                    </div>
                </div>
                <button onclick="copyKey()" class="w-full bg-brand-text text-brand-base font-mono text-[10px] uppercase py-3 hover:opacity-80 transition-colors mb-6 flex items-center justify-center gap-2">
                    <i data-lucide="copy" width="12" height="12"></i> Copy Key to Clipboard
                </button>
                
                <div class="border-t border-brand-line pt-6">
                    <p class="font-mono text-[10px] tracking-wide text-brand-muted uppercase mb-2">Import Data Key</p>
                    <div class="flex items-center border-b border-brand-line py-1 mb-4">
                        <input type="text" id="recoverKeyInput" class="w-full bg-transparent text-brand-text font-mono text-sm outline-none placeholder-brand-muted/50" placeholder="PASTE KEY HERE">
                    </div>
                    <button onclick="recoverData()" class="w-full border border-brand-text text-brand-text font-mono text-[10px] uppercase py-3 hover:bg-brand-surface transition-colors">
                        Import & Overwrite
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Bonus Exercise Modal -->
    <div id="addExModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal('addExModal')"></div>
        <div class="relative bg-brand-base border border-brand-line w-full max-w-md industrial-shadow">
             <div class="px-6 py-4 border-b border-brand-line bg-brand-surface flex justify-between items-center">
                <h3 class="font-mono text-[10px] tracking-[0.2em] text-brand-text uppercase flex items-center gap-2">
                    <i data-lucide="plus" width="14" height="14"></i> Bonus Exercise
                </h3>
                <button onclick="closeModal('addExModal')"><i data-lucide="x" width="16" class="text-brand-muted"></i></button>
            </div>
            <div class="p-8">
                <div class="mb-4">
                    <label class="block font-mono text-[10px] tracking-[0.15em] text-brand-muted uppercase mb-2">Exercise Name</label>
                    <input type="text" id="newExName" class="w-full bg-transparent border-b border-brand-line focus:border-brand-forest text-brand-text text-lg outline-none font-medium placeholder-brand-muted/30 pb-1" placeholder="e.g. Preacher Curls">
                </div>
                <div class="mb-6">
                    <label class="block font-mono text-[10px] tracking-[0.15em] text-brand-muted uppercase mb-2">Target (Sets x Reps)</label>
                    <input type="text" id="newExTarget" class="w-full bg-transparent border-b border-brand-line focus:border-brand-forest text-brand-text text-lg outline-none font-medium placeholder-brand-muted/30 pb-1" value="3 x 10-12">
                </div>
                <input type="hidden" id="editExId" value="">
                
                <div class="flex gap-2">
                    <button type="button" id="deleteExBtn" onclick="deleteBonusExercise()" class="hidden w-1/3 border border-rust text-rust font-mono text-[10px] uppercase py-3 hover:bg-rust hover:text-white transition-colors">
                        Delete
                    </button>
                    <button type="button" onclick="saveBonusExercise()" class="w-full bg-brand-text text-brand-base font-mono text-[10px] uppercase py-3 hover:opacity-80 transition-colors">
                        Save Exercise
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Plate Calculator Modal -->
    <div id="calcModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal('calcModal')"></div>
        <div class="relative bg-brand-base border border-brand-line w-full max-w-md industrial-shadow">
             <div class="px-6 py-4 border-b border-brand-line bg-brand-surface flex justify-between items-center">
                <h3 class="font-mono text-[10px] tracking-[0.2em] text-brand-text uppercase flex items-center gap-2">
                    <i data-lucide="disc" width="14" height="14"></i> Plate Calc
                </h3>
                <button onclick="closeModal('calcModal')"><i data-lucide="x" width="16" class="text-brand-muted"></i></button>
            </div>
            <div class="p-8">
                <div class="mb-6">
                    <label class="block font-mono text-[10px] tracking-[0.15em] text-brand-muted uppercase mb-2">Target Weight (Lbs)</label>
                    <div class="flex items-center border-b border-brand-line focus-within:border-brand-forest transition-colors py-1">
                        <input type="number" id="targetWeight" oninput="calculatePlates()" 
                            class="w-full bg-transparent text-brand-text text-3xl font-medium outline-none font-mono placeholder-brand-muted/30" placeholder="225">
                    </div>
                </div>
                
                <div class="bg-brand-surface border border-brand-line p-4 min-h-[140px] flex flex-col items-center justify-center gap-4">
                    <div id="calcResult" class="font-mono text-xs uppercase text-brand-muted">Enter weight > 45</div>
                    <div id="platesVisual" class="flex gap-1 items-center justify-center h-20 w-full relative"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats/Consistency Modal -->
    <div id="statsModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal('statsModal')"></div>
        <div class="relative bg-brand-base border border-brand-line w-full max-w-lg industrial-shadow">
             <div class="px-6 py-4 border-b border-brand-line bg-brand-surface flex justify-between items-center">
                <h3 class="font-mono text-[10px] tracking-[0.2em] text-brand-text uppercase flex items-center gap-2">
                    <i data-lucide="activity" width="14" height="14"></i> Consistency (Last 7 Days)
                </h3>
                <button onclick="closeModal('statsModal')"><i data-lucide="x" width="16" class="text-brand-muted"></i></button>
            </div>
            <div class="p-6 md:p-8">
                <div id="statsContent" class="w-full">
                    <!-- JS Injected Here -->
                </div>
                <div class="flex justify-between items-center mt-6 border-t border-brand-line pt-4">
                    <p class="font-mono text-[10px] uppercase text-brand-muted">Legend</p>
                    <div class="flex gap-3 font-mono text-[9px] uppercase text-brand-text">
                        <span class="flex items-center gap-1"><div class="w-2 h-2 bg-forest-500 rounded-sm"></div> Wkt</span>
                        <span class="flex items-center gap-1"><div class="w-2 h-2 bg-brass rounded-sm"></div> Food</span>
                        <span class="flex items-center gap-1"><div class="w-2 h-2 bg-brand-line/40 rounded-sm border border-brand-line"></div> Miss</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-brand-text text-brand-base px-6 py-3 rounded-none font-mono text-[10px] uppercase tracking-widest transition-opacity duration-300 opacity-0 pointer-events-none industrial-shadow z-50">
        Changes Saved
    </div>

    <script>
        // --- APP STATE ---
        let appData = { workouts: {}, meals: {}, extraExercises: {} };
        const LOCAL_STORAGE_KEY = 'recomp_offline_data';

        const workoutData = {
            'Monday': {
                AM: [
                    { id: 'm_am_1', name: 'DB Lateral Raises', target: '4 x 15-20', type: 'reps_only' },
                    { id: 'm_am_2', name: 'Barbell Bicep Curls', target: '3 x 10-12' },
                    { id: 'm_am_3', name: 'Tricep Rope Pushdowns', target: '3 x 12-15' }
                ],
                PM: [
                    { id: 'm_pm_1', name: 'Incline DB Bench Press', target: '4 x 8-10' },
                    { id: 'm_pm_2', name: 'Flat Barbell Bench', target: '3 x 6-8' },
                    { id: 'm_pm_3', name: 'Seated DB Shoulder Press', target: '3 x 8-10' },
                    { id: 'm_pm_4', name: 'Cable Lateral Raises', target: '4 x 15-20' },
                    { id: 'm_pm_5', name: 'Overhead Tricep Extension', target: '3 x 10-12' }
                ]
            },
            'Tuesday': {
                AM: [
                    { id: 't_am_1', name: 'Incline Walk (Zone 2)', target: '25 mins', type: 'cardio' },
                    { id: 't_am_2', name: 'Hanging Leg Raises', target: '3 x Failure', type: 'reps_only' }
                ],
                PM: [
                    { id: 't_pm_1', name: 'Barbell Rows', target: '4 x 6-8' },
                    { id: 't_pm_2', name: 'Lat Pulldowns', target: '3 x 8-10' },
                    { id: 't_pm_3', name: 'Chest-Supported Rows', target: '3 x 10-12' },
                    { id: 't_pm_4', name: 'Reverse Pec Deck (Rear Delts)', target: '4 x 15-20' },
                    { id: 't_pm_5', name: 'Hammer Curls', target: '3 x 10-12' }
                ]
            },
            'Wednesday': {
                AM: [
                    { id: 'w_am_1', name: 'Upright Rows', target: '3 x 12-15' },
                    { id: 'w_am_2', name: 'Cable Lateral Raises', target: '4 x 15-20' },
                    { id: 'w_am_3', name: 'Preacher Curls', target: '3 x 10-12' }
                ],
                PM: [
                    { id: 'w_pm_1', name: 'Barbell Squats', target: '4 x 6-8' },
                    { id: 'w_pm_2', name: 'Leg Press', target: '3 x 10-12' },
                    { id: 'w_pm_3', name: 'Leg Extensions', target: '3 x 12-15' },
                    { id: 'w_pm_4', name: 'Lying Leg Curls', target: '4 x 12-15' },
                    { id: 'w_pm_5', name: 'Standing Calf Raises', target: '4 x 15-20' }
                ]
            },
            'Thursday': {
                AM: [
                    { id: 'th_am_1', name: 'Incline Walk (Zone 2)', target: '25 mins', type: 'cardio' },
                    { id: 'th_am_2', name: 'Cable Crunches', target: '3 x 15-20' }
                ],
                PM: [
                    { id: 'th_pm_1', name: 'Overhead Press (OHP)', target: '4 x 6-8' },
                    { id: 'th_pm_2', name: 'DB Lateral Raises', target: '4 x 12-15' },
                    { id: 'th_pm_3', name: 'Incline Machine Press', target: '3 x 8-10' },
                    { id: 'th_pm_4', name: 'Pec Deck Flys', target: '3 x 12-15' },
                    { id: 'th_pm_5', name: 'Skull Crushers', target: '3 x 10-12' }
                ]
            },
            'Friday': {
                AM: [
                    { id: 'f_am_1', name: 'Face Pulls', target: '3 x 15-20' },
                    { id: 'f_am_2', name: 'DB Lateral Raises', target: '4 x 15-20' },
                    { id: 'f_am_3', name: 'Incline DB Curls', target: '3 x 10-12' }
                ],
                PM: [
                    { id: 'f_pm_1', name: 'Weighted Pull-Ups', target: '4 x 6-8' },
                    { id: 'f_pm_2', name: 'Single-Arm DB Row', target: '3 x 8-10' },
                    { id: 'f_pm_3', name: 'Seated Cable Rows', target: '3 x 10-12' },
                    { id: 'f_pm_4', name: 'Rear Delt DB Flys', target: '4 x 15-20' },
                    { id: 'f_pm_5', name: 'EZ Bar Curls', target: '3 x 8-10' }
                ]
            },
            'Saturday': {
                AM: [
                    { id: 's_am_1', name: 'Incline Walk (Zone 2)', target: '25 mins', type: 'cardio' },
                    { id: 's_am_2', name: 'Plank', target: '3 x Max Time', type: 'duration' }
                ],
                PM: [
                    { id: 's_pm_1', name: 'Romanian Deadlifts', target: '4 x 8-10' },
                    { id: 's_pm_2', name: 'Hack Squats', target: '3 x 8-10' },
                    { id: 's_pm_3', name: 'Bulgarian Split Squats', target: '3 x 10-12' },
                    { id: 's_pm_4', name: 'Seated Leg Curls', target: '3 x 12-15' },
                    { id: 's_pm_5', name: 'Seated Calf Raises', target: '4 x 15-20' }
                ]
            },
            'Sunday': { AM: [], PM: [] }
        };

        const meals = [
            { id: 'm1', targetTime: '08:00', name: 'High-Cal Breakfast', desc: '4 Eggs, Oats, PB, Whole Milk', details: '• 4 Whole Eggs (scrambled)\n• 1.5 cups Oatmeal (cooked with whole milk)\n• 2 tbsp Peanut Butter\n• 1 Banana' },
            { id: 'm2', targetTime: '11:00', name: 'Mid-Day Gainer', desc: 'Serious Mass Shake', details: '• 1 Scoop Serious Mass Protein Powder\n• 16 oz Whole Milk\n• 1 tbsp Olive Oil\n• Blend well' },
            { id: 'm3', targetTime: '14:00', name: 'Bulking Lunch', desc: '8oz Ground Beef, 1.5c Rice, Veggies', details: '• 8 oz 80/20 Ground Beef\n• 1.5 cups White Rice\n• 1 cup Mixed Veggies' },
            { id: 'm4', targetTime: '16:30', name: 'Pre-Workout Fuel', desc: 'Carbs & Fast Protein', details: '• 2 Rice Krispie Treats or 1 Large Bagel\n• 1 scoop Whey Isolate' },
            { id: 'm5', targetTime: '19:30', name: 'Post-Workout Dinner', desc: 'Chicken/Pasta Feast', details: '• 8 oz Chicken Breast or Salmon\n• 2 cups Pasta\n• 2 slices Garlic Bread' },
            { id: 'm6', targetTime: '22:00', name: 'Before Bed', desc: 'Cottage Cheese & Nuts', details: '• 1 cup Cottage Cheese\n• 1/4 cup Almonds' }
        ];

        // --- UI STATE & DATE HELPERS ---
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const shortDays = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
        let currentDayIdx = new Date().getDay();
        let selectedDay = days[currentDayIdx];
        let activeTab = (new Date().getHours() < 12) ? 'AM' : 'PM';

        // Robust Local Date Generator (Prevents timezone spillover)
        function getLocalISOString(date) {
            const offset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() - offset).toISOString().split('T')[0];
        }
        
        function getTodayDateStr() { 
            return getLocalISOString(new Date()); 
        }

        // Returns the actual calendar date relative to the tab selected 
        // e.g. If today is Wed, and you click Mon, it returns Monday's actual YYYY-MM-DD
        function getSelectedDateStr() {
            const today = new Date();
            const diff = days.indexOf(selectedDay) - today.getDay();
            const d = new Date(today);
            d.setDate(today.getDate() + diff);
            return getLocalISOString(d);
        }

        function init() {
            renderDaySelector();
            updateDateHeader();
            updateTabVisibility(); 
            try {
                const local = localStorage.getItem(LOCAL_STORAGE_KEY);
                if(local) {
                    const parsed = JSON.parse(local);
                    appData = { ...appData, ...parsed };
                }
            } catch (e) { console.error(e); }
            renderContent();
            
            updateConsistencyUI();
            updateUrgencyUI();
            setInterval(updateUrgencyUI, 60000); 
        }

        function updateDateHeader() {
            const today = new Date();
            const options = { weekday: 'long', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').innerText = today.toLocaleDateString('en-US', options);
        }

        function renderDaySelector() {
            const selector = document.getElementById('daySelector');
            selector.innerHTML = '';
            days.forEach((day, idx) => {
                const isSelected = day === selectedDay;
                const btn = document.createElement('button');
                btn.className = `px-4 py-2 font-mono text-[10px] uppercase tracking-widest transition-all rounded-full border ${isSelected ? 'bg-brand-forest text-brand-base border-brand-forest' : 'bg-brand-base text-brand-muted border-brand-line hover:border-brand-accent'}`;
                btn.innerText = shortDays[idx];
                btn.onclick = () => {
                    selectedDay = day;
                    renderDaySelector();
                    updateTabVisibility(); 
                    renderContent();
                };
                selector.appendChild(btn);
            });
        }

        function updateTabVisibility() {
            const amBtn = document.getElementById('tab-AM');
            const pmBtn = document.getElementById('tab-PM');
            const foodBtn = document.getElementById('tab-FOOD');
            if (selectedDay === 'Sunday') {
                amBtn.style.display = 'none';
                pmBtn.style.display = 'none';
                setTab('FOOD');
            } else {
                amBtn.style.display = 'block';
                amBtn.style.display = 'block';
            }
        }

        window.setTab = function(tabName) {
            activeTab = tabName;
            ['AM', 'PM', 'FOOD'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                btn.classList.remove('bg-brand-base', 'text-brand-text');
                btn.classList.add('text-brand-muted');
            });
            const activeBtn = document.getElementById(`tab-${tabName}`);
            activeBtn.classList.remove('text-brand-muted');
            activeBtn.classList.add('bg-brand-base', 'text-brand-text');
            renderContent();
        }

        function renderContent() {
            const content = document.getElementById('content');
            content.innerHTML = '';

            const dateKey = getSelectedDateStr();

            if (activeTab === 'FOOD') {
                const todaysMeals = appData.meals[dateKey] || {};
                meals.forEach(meal => {
                    const isChecked = todaysMeals[meal.id] === true;
                    const div = document.createElement('div');
                    div.id = `meal-card-${meal.id}`;
                    div.className = `bg-brand-base p-6 flex items-start gap-4 transition-all duration-500 hover:bg-brand-surface cursor-pointer group relative border-l-2 border-transparent`;
                    div.onclick = (e) => { if(!e.target.closest('button')) toggleMeal(meal.id); };
                    div.innerHTML = `
                        <div class="mt-1 w-5 h-5 border border-brand-muted flex items-center justify-center transition-colors ${isChecked ? 'bg-brand-forest border-brand-forest' : ''}">
                            ${isChecked ? '<i data-lucide="check" class="text-white w-3 h-3"></i>' : ''}
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <h4 class="font-medium text-brand-text ${isChecked ? 'line-through opacity-50' : ''}">${meal.name}</h4>
                                <span id="meal-time-${meal.id}" class="font-mono text-[9px] uppercase tracking-wider text-brand-muted border border-brand-line bg-transparent px-1.5 py-0.5 rounded-sm transition-all duration-500">${formatTime(meal.targetTime)}</span>
                            </div>
                            <p class="text-sm text-brand-muted mt-1 font-mono leading-relaxed ${isChecked ? 'line-through opacity-50' : ''}">${meal.desc}</p>
                        </div>
                        <button onclick="openMealInfo(event, '${meal.id}')" class="w-12 h-12 flex items-center justify-center -mt-2 -mr-2 text-brand-muted hover:text-brand-text hover:bg-brand-line/30 rounded-full transition-colors relative z-20">
                            <i data-lucide="info" width="20" height="20"></i>
                        </button>
                    `;
                    content.appendChild(div);
                });
            } else {
                const sessionExercises = workoutData[selectedDay] ? workoutData[selectedDay][activeTab] : [];
                
                if(!appData.extraExercises) appData.extraExercises = {};
                if(!appData.extraExercises[dateKey]) appData.extraExercises[dateKey] = { AM: [], PM: [] };
                
                const bonusExercises = appData.extraExercises[dateKey][activeTab] || [];
                const allExercises = [...sessionExercises, ...bonusExercises];

                if (!allExercises || allExercises.length === 0) {
                    content.innerHTML = `<div class="bg-brand-base p-12 flex flex-col items-center justify-center text-brand-muted"><i data-lucide="coffee" width="32" height="32" class="mb-4 opacity-50"></i><p class="font-mono text-[10px] tracking-widest uppercase">Rest Day</p></div>`;
                } else {
                    allExercises.forEach(ex => {
                        const key = getStorageKey(selectedDay, ex.id);
                        const todayData = appData.workouts[key] || {};
                        const history = getHistory(ex.name);
                        const numSets = getSetCount(ex.target, ex.type);

                        let historyHTML = '';
                        if (history) {
                            let text = '';
                            if (ex.type === 'cardio') {
                                text = `${history.sets?.[0]?.t || '-'}m / ${history.sets?.[0]?.w || '-'}spd / ${history.sets?.[0]?.r || '-'}inc`;
                            } else if (ex.type === 'reps_only' || ex.type === 'duration') {
                                text = `${(history.sets||[]).map(s => s.r || '-').join(', ')}`;
                            } else {
                                text = `${(history.sets||[]).map(s => s.w ? `${s.w}x${s.r}` : s.r || '-').join(', ')}`;
                            }
                            historyHTML = `<div class="inline-flex items-center px-2 py-1 bg-brand-surface border border-brand-line text-[10px] font-mono uppercase text-brand-muted mb-4"><div class="flex items-center gap-1.5"><i data-lucide="history" width="10" height="10"></i> <span>Last: ${text}</span></div></div>`;
                        }

                        let setsHTML = `<div class="flex flex-col gap-2 mb-4" id="sets-${ex.id}">`;
                        for(let i=0; i<numSets; i++) {
                            const setData = (todayData.sets && todayData.sets[i]) ? todayData.sets[i] : {w:'', r:'', t:''};
                            const inputBase = "bg-transparent border-b border-brand-line focus:border-brand-forest text-center font-mono text-sm py-1 outline-none transition-colors w-full text-brand-text placeholder-brand-muted/30";
                            
                            let inputs = '';
                            let gridCols = 'grid-cols-2';

                            if (ex.type === 'cardio') {
                                gridCols = 'grid-cols-3';
                                inputs = `<input type="number" class="${inputBase}" placeholder="Min" value="${setData.t || ''}" onchange="saveSet('${ex.id}', ${i}, 't', this.value)">
                                          <input type="number" step="0.1" class="${inputBase}" placeholder="Spd" value="${setData.w || ''}" onchange="saveSet('${ex.id}', ${i}, 'w', this.value)">
                                          <input type="number" step="0.5" class="${inputBase}" placeholder="Inc" value="${setData.r || ''}" onchange="saveSet('${ex.id}', ${i}, 'r', this.value)">`;
                            } else if (ex.type === 'reps_only' || ex.type === 'duration') {
                                gridCols = 'grid-cols-1';
                                inputs = `<input type="text" class="${inputBase}" placeholder="${ex.type === 'duration' ? 'Time' : 'Reps'}" value="${setData.r || ''}" onchange="saveSet('${ex.id}', ${i}, 'r', this.value)">`;
                            } else {
                                inputs = `<input type="number" class="${inputBase} autofill-target" id="w-${ex.id}-${i}" placeholder="Lbs" value="${setData.w || ''}" onchange="handleFirstSetAutofill('${ex.id}', 'w', this.value)">
                                          <input type="number" class="${inputBase}" placeholder="Reps" value="${setData.r || ''}" onchange="saveSet('${ex.id}', ${i}, 'r', this.value)">`;
                            }

                            setsHTML += `<div class="grid grid-cols-[40px_1fr] gap-4 items-center"><span class="font-mono text-[10px] text-brand-muted text-right pr-2 border-r border-brand-line">0${i+1}</span><div class="grid ${gridCols} gap-4">${inputs}</div></div>`;
                        }
                        setsHTML += '</div>';

                        const r = todayData.rating;
                        const ratingHTML = `<div class="flex justify-end gap-2 mt-2">
                            <button onclick="saveRating('${ex.id}', 'easy')" class="w-6 h-6 rounded-full border border-brand-line flex items-center justify-center ${r==='easy' ? 'bg-forest-500 border-forest-500' : ''}"><span class="w-2 h-2 rounded-full ${r==='easy' ? 'bg-white' : 'bg-forest-500'}"></span></button>
                            <button onclick="saveRating('${ex.id}', 'med')" class="w-6 h-6 rounded-full border border-brand-line flex items-center justify-center ${r==='med' ? 'bg-brass border-brass' : ''}"><span class="w-2 h-2 rounded-full ${r==='med' ? 'bg-white' : 'bg-brass'}"></span></button>
                            <button onclick="saveRating('${ex.id}', 'hard')" class="w-6 h-6 rounded-full border border-brand-line flex items-center justify-center ${r==='hard' ? 'bg-rust border-rust' : ''}"><span class="w-2 h-2 rounded-full ${r==='hard' ? 'bg-white' : 'bg-rust'}"></span></button>
                        </div>`;

                        const titleClick = ex.isBonus ? `openAddExModal('${ex.id}')` : `openGoogleSearch('${ex.name.replace(/'/g, "\\'")}')`;
                        const titleColor = ex.isBonus ? `text-brand-accent` : `text-brand-text`;
                        const badge = ex.isBonus ? `<span class="ml-2 inline-block bg-brand-surface border border-brand-line text-brand-muted px-1.5 py-0.5 text-[8px] rounded-sm relative -top-0.5">BONUS</span>` : '';

                        const card = document.createElement('div');
                        card.className = 'bg-brand-base p-6 md:p-8 relative';
                        card.innerHTML = `<div class="mb-4">
                            <h3 class="text-lg font-medium ${titleColor} leading-tight cursor-pointer hover:underline" onclick="${titleClick}">${ex.name} ${badge}</h3>
                            <p class="font-mono text-[10px] tracking-wider text-brand-muted uppercase mt-1">${ex.target}</p>
                        </div>${historyHTML}${setsHTML}${ratingHTML}`;
                        content.appendChild(card);
                    });

                    // Render Add Bonus Button
                    if (sessionExercises.length > 0 && bonusExercises.length < 3) {
                        const addBtnContainer = document.createElement('div');
                        addBtnContainer.className = 'p-6 bg-brand-base relative';
                        addBtnContainer.innerHTML = `
                            <button onclick="openAddExModal()" class="w-full py-4 border-2 border-dashed border-brand-line text-brand-muted hover:border-brand-text hover:text-brand-text hover:bg-brand-surface transition-colors font-mono text-[10px] tracking-widest uppercase flex items-center justify-center gap-2">
                                <i data-lucide="plus" width="14" height="14"></i> Add Bonus Exercise (${3 - bonusExercises.length} left)
                            </button>
                        `;
                        content.appendChild(addBtnContainer);
                    }
                }
            }
            lucide.createIcons();
            updateUrgencyUI(); 
        }

        // --- OVERALL CONSISTENCY TRACKING ---
        function updateConsistencyUI() {
            let totalScore = 0;
            let maxScore = 0;

            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const ds = getLocalISOString(d);
                const dayOfWeek = days[d.getDay()];

                // Eval AM
                const amEx = workoutData[dayOfWeek].AM;
                if(amEx.length > 0) {
                    maxScore++;
                    if(amEx.some(ex => appData.workouts[`${ds}_${ex.id}`]?.sets.some(s => s.w || s.r || s.t))) totalScore++;
                }
                
                // Eval PM
                const pmEx = workoutData[dayOfWeek].PM;
                if(pmEx.length > 0) {
                    maxScore++;
                    if(pmEx.some(ex => appData.workouts[`${ds}_${ex.id}`]?.sets.some(s => s.w || s.r || s.t))) totalScore++;
                }
                
                // Eval Meals
                maxScore += meals.length;
                const mData = appData.meals[ds] || {};
                totalScore += Object.values(mData).filter(v => v).length;
            }

            const pct = maxScore > 0 ? (totalScore / maxScore) * 100 : 0;
            const dot = document.getElementById('consistency-dot');
            
            dot.className = 'absolute -top-1 -right-1 w-2 h-2 rounded-full transition-all duration-500 opacity-100 shadow-sm';
            if (pct >= 75) dot.classList.add('bg-forest-500');
            else if (pct >= 40) dot.classList.add('bg-brass');
            else dot.classList.add('bg-rust');
        }

        window.openStatsModal = () => {
            document.getElementById('statsModal').classList.remove('hidden');
            let html = '<div class="flex items-end h-40 pt-4 w-full gap-1 sm:gap-2">';
            let totalScore = 0;
            let maxScore = 0;

            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const ds = getLocalISOString(d);
                const dayOfWeek = days[d.getDay()];
                const shortD = shortDays[d.getDay()];

                // AM logic
                const amEx = workoutData[dayOfWeek].AM;
                const amExpected = amEx.length > 0;
                let amDone = false;
                if(amExpected) {
                    amDone = amEx.some(ex => appData.workouts[`${ds}_${ex.id}`]?.sets.some(s => s.w || s.r || s.t));
                    maxScore++;
                    if(amDone) totalScore++;
                }

                // PM logic
                const pmEx = workoutData[dayOfWeek].PM;
                const pmExpected = pmEx.length > 0;
                let pmDone = false;
                if(pmExpected) {
                    pmDone = pmEx.some(ex => appData.workouts[`${ds}_${ex.id}`]?.sets.some(s => s.w || s.r || s.t));
                    maxScore++;
                    if(pmDone) totalScore++;
                }

                // Meals logic
                const mData = appData.meals[ds] || {};
                const mealsEaten = Object.values(mData).filter(v => v).length;
                const mealTarget = meals.length;
                
                maxScore += mealTarget;
                totalScore += mealsEaten;

                // Visual Blocks
                let amClass = amExpected ? (amDone ? 'bg-forest-500' : 'bg-brand-line/40 border border-brand-line') : 'bg-transparent border border-dashed border-brand-line/40';
                let pmClass = pmExpected ? (pmDone ? 'bg-forest-500' : 'bg-brand-line/40 border border-brand-line') : 'bg-transparent border border-dashed border-brand-line/40';
                let mealPct = Math.round((mealsEaten / mealTarget) * 100);

                let isToday = i === 0;

                html += `
                    <div class="flex flex-col items-center gap-1 flex-1">
                        <div class="w-full flex flex-col gap-1 mb-2 h-full justify-end">
                            <div class="h-6 rounded-[2px] w-full ${amClass}"></div>
                            <div class="h-6 rounded-[2px] w-full ${pmClass}"></div>
                            <div class="h-16 rounded-[2px] w-full bg-brand-line/20 relative overflow-hidden border border-brand-line/50">
                                <div class="absolute bottom-0 w-full bg-brass transition-all duration-700" style="height: ${mealPct}%"></div>
                            </div>
                        </div>
                        <span class="font-mono text-[10px] uppercase ${isToday ? 'text-brand-text font-bold' : 'text-brand-muted'}">${shortD}</span>
                    </div>
                `;
            }
            html += '</div>';

            const pct = maxScore > 0 ? Math.round((totalScore/maxScore)*100) : 0;
            document.getElementById('statsContent').innerHTML = `
                <div class="mb-4 flex justify-between items-end border-b border-brand-line pb-4">
                    <div>
                        <p class="font-mono text-[10px] tracking-wide text-brand-muted uppercase">7-Day Compliance</p>
                        <p class="text-3xl font-medium text-brand-text leading-none mt-1">${pct}%</p>
                    </div>
                </div>
                ${html}
            `;
        };

        // --- ELEGANT URGENCY SYSTEM ---
        function updateUrgencyUI() {
            if (selectedDay !== days[new Date().getDay()]) {
                applyUrgencyTab('AM', null);
                applyUrgencyTab('PM', null);
                applyUrgencyTab('FOOD', null);
                meals.forEach(m => applyUrgencyMeal(m.id, null));
                return;
            }

            const amUrg = getUrgencyLevel('08:00', isSessionCompleted('AM')); 
            applyUrgencyTab('AM', amUrg);

            const pmUrg = getUrgencyLevel('18:00', isSessionCompleted('PM')); 
            applyUrgencyTab('PM', pmUrg);

            const dateKey = getTodayDateStr(); 
            const todaysMeals = appData.meals[dateKey] || {};
            let highestFoodUrg = null;
            const urgPriority = { 'red': 3, 'yellow': 2, 'green': 1 };

            meals.forEach(meal => {
                const isCompleted = todaysMeals[meal.id] === true;
                const mUrg = getUrgencyLevel(meal.targetTime, isCompleted);
                if (mUrg && (!highestFoodUrg || urgPriority[mUrg] > urgPriority[highestFoodUrg])) highestFoodUrg = mUrg;
                applyUrgencyMeal(meal.id, mUrg);
            });

            applyUrgencyTab('FOOD', highestFoodUrg);
        }

        function getUrgencyLevel(targetTimeStr, isCompleted) {
            if (isCompleted) return null;
            const now = new Date();
            const [targetH, targetM] = targetTimeStr.split(':').map(Number);
            const target = new Date();
            target.setHours(targetH, targetM, 0, 0);

            const diffMinutes = (now - target) / (1000 * 60);
            if (diffMinutes >= -90 && diffMinutes < 0) return 'green'; 
            if (diffMinutes >= 0 && diffMinutes <= 60) return 'yellow'; 
            if (diffMinutes > 60) return 'red'; 
            return null; 
        }

        function isSessionCompleted(sessionName) {
            const dateKey = getTodayDateStr();
            const exList = workoutData[selectedDay]?.[sessionName] || [];
            if(exList.length === 0) return true; 

            for (let ex of exList) {
                const key = `${dateKey}_${ex.id}`;
                if (appData.workouts[key] && appData.workouts[key].sets && appData.workouts[key].sets.some(s => s.w || s.r || s.t)) {
                    return true;
                }
            }
            return false;
        }

        function applyUrgencyTab(tabId, level) {
            const dot = document.getElementById(`dot-${tabId}`);
            if (!dot) return;
            
            dot.className = 'absolute top-2.5 right-3 w-1.5 h-1.5 rounded-full transition-all duration-500 opacity-0';
            
            if (level === 'green') {
                dot.classList.add('bg-forest-500', 'shadow-[0_0_6px_#4A6B56]', 'opacity-100');
            } else if (level === 'yellow') {
                dot.classList.add('bg-brass', 'shadow-[0_0_6px_#C29A5B]', 'opacity-100');
            } else if (level === 'red') {
                dot.classList.add('bg-rust', 'shadow-[0_0_6px_#C86A58]', 'animate-pulse', 'opacity-100');
            }
        }

        function applyUrgencyMeal(mealId, level) {
            const card = document.getElementById(`meal-card-${mealId}`);
            const timeEl = document.getElementById(`meal-time-${mealId}`);
            if (!card || !timeEl) return;

            const cardBase = "p-6 flex items-start gap-4 transition-all duration-500 hover:bg-brand-surface cursor-pointer group relative border-l-2 ";
            const timeBase = "font-mono text-[9px] uppercase tracking-wider px-1.5 py-0.5 rounded-sm transition-all duration-500 border ";

            if (level === 'green') {
                card.className = cardBase + 'bg-forest-500/5 border-forest-500';
                timeEl.className = timeBase + 'text-forest-500 border-forest-500/30 bg-forest-500/10 font-bold';
            } else if (level === 'yellow') {
                card.className = cardBase + 'bg-brass/5 border-brass';
                timeEl.className = timeBase + 'text-brass border-brass/30 bg-brass/10 font-bold';
            } else if (level === 'red') {
                card.className = cardBase + 'bg-rust/5 border-rust';
                timeEl.className = timeBase + 'text-rust border-rust/30 bg-rust/10 font-bold';
            } else {
                card.className = cardBase + 'bg-brand-base border-transparent';
                timeEl.className = timeBase + 'text-brand-muted border-brand-line bg-transparent';
            }
        }

        function formatTime(timeStr) {
            const [h, m] = timeStr.split(':').map(Number);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const h12 = h % 12 || 12;
            return `${h12}:${m.toString().padStart(2, '0')} ${ampm}`;
        }

        // --- DATA & SAVING LOGIC ---
        function getStorageKey(day, id) { return `${getSelectedDateStr()}_${id}`; }
        function getSetCount(targetStr, type) { return (type === 'cardio') ? 1 : (parseInt(targetStr?.match(/^(\d+)/)?.[1]) || 1); }

        function saveData() { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appData)); }

        function showToast(msg = "CHANGES SAVED") {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('opacity-0');
            setTimeout(() => { t.classList.add('opacity-0'); setTimeout(() => t.innerText = "CHANGES SAVED", 300); }, 1500);
        }

        window.saveSet = function(exId, setIndex, field, value) {
            const key = getStorageKey(selectedDay, exId);
            if(!appData.workouts[key]) appData.workouts[key] = { sets: [], date: getSelectedDateStr(), exerciseId: exId };
            if(!appData.workouts[key].sets[setIndex]) appData.workouts[key].sets[setIndex] = {w:'', r:'', t:''};
            appData.workouts[key].sets[setIndex][field] = value;
            saveData();
            showToast();
            updateUrgencyUI(); 
            updateConsistencyUI();
        }

        window.saveRating = function(exId, rating) {
            const key = getStorageKey(selectedDay, exId);
            if(!appData.workouts[key]) appData.workouts[key] = { sets: [], date: getSelectedDateStr(), exerciseId: exId };
            appData.workouts[key].rating = rating;
            saveData();
            showToast();
            renderContent(); 
        }

        window.toggleMeal = function(mealId) {
            const dateKey = getSelectedDateStr();
            if(!appData.meals[dateKey]) appData.meals[dateKey] = {};
            appData.meals[dateKey][mealId] = !appData.meals[dateKey][mealId];
            saveData();
            showToast();
            renderContent(); 
            updateConsistencyUI();
        }

        window.handleFirstSetAutofill = function(exId, field, value) {
            saveSet(exId, 0, field, value);
            const container = document.getElementById(`sets-${exId}`);
            if(!container) return;
            const inputs = container.querySelectorAll('.autofill-target');
            inputs.forEach((input, i) => { if(i > 0 && !input.value) { input.value = value; saveSet(exId, i, field, value); }});
        }

        // --- BONUS EXERCISES LOGIC ---
        window.openAddExModal = function(exId) {
            if (typeof exId !== 'string') exId = null; 
            
            const dateKey = getSelectedDateStr();
            const modal = document.getElementById('addExModal');
            const nameInput = document.getElementById('newExName');
            const targetInput = document.getElementById('newExTarget');
            const idInput = document.getElementById('editExId');
            const deleteBtn = document.getElementById('deleteExBtn');

            if (exId) {
                const exercises = appData.extraExercises[dateKey]?.[activeTab] || [];
                const ex = exercises.find(e => e.id === exId);
                if(ex) {
                    nameInput.value = ex.name;
                    targetInput.value = ex.target;
                    idInput.value = ex.id;
                    deleteBtn.classList.remove('hidden');
                }
            } else {
                nameInput.value = '';
                targetInput.value = '3 x 10-12';
                idInput.value = '';
                deleteBtn.classList.add('hidden');
            }

            modal.classList.remove('hidden');
            nameInput.focus();
        };

        window.saveBonusExercise = function() {
            const name = document.getElementById('newExName').value.trim();
            const target = document.getElementById('newExTarget').value.trim();
            const exId = document.getElementById('editExId').value;
            const dateKey = getSelectedDateStr();

            if (!name) return;

            if(!appData.extraExercises) appData.extraExercises = {};
            if(!appData.extraExercises[dateKey]) appData.extraExercises[dateKey] = { AM: [], PM: [] };
            const list = appData.extraExercises[dateKey][activeTab];

            if (exId) {
                const ex = list.find(e => e.id === exId);
                if (ex) {
                    ex.name = name;
                    ex.target = target;
                }
            } else {
                if (list.length >= 3) {
                    closeModal('addExModal');
                    return;
                }
                list.push({
                    id: `bonus_${Date.now()}`,
                    name: name,
                    target: target || "3 x 10-12",
                    isBonus: true
                });
            }

            saveData();
            showToast();
            closeModal('addExModal');
            renderContent();
            updateConsistencyUI();
        }

        window.deleteBonusExercise = function() {
            const exId = document.getElementById('editExId').value;
            if (!exId) return;
            
            const dateKey = getSelectedDateStr();
            if (appData.extraExercises && appData.extraExercises[dateKey] && appData.extraExercises[dateKey][activeTab]) {
                const list = appData.extraExercises[dateKey][activeTab];
                appData.extraExercises[dateKey][activeTab] = list.filter(e => e.id !== exId);
            }
            
            const storageKey = getStorageKey(selectedDay, exId);
            delete appData.workouts[storageKey];
            
            saveData();
            showToast("EXERCISE DELETED");
            closeModal('addExModal');
            renderContent();
            updateConsistencyUI();
        };

        // --- UTILITIES & MODALS ---
        window.openCalcModal = () => document.getElementById('calcModal').classList.remove('hidden');
        window.openKeyModal = () => {
            document.getElementById('keyModal').classList.remove('hidden');
            document.getElementById('currentKeyDisplay').innerText = btoa(JSON.stringify(appData));
        };
        window.openMealInfo = (e, id) => {
            const meal = meals.find(m => m.id === id);
            document.getElementById('modalTitle').innerText = meal.name;
            document.getElementById('modalBody').innerText = meal.details;
            document.getElementById('infoModal').classList.remove('hidden');
        };
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.openGoogleSearch = (term) => window.open('https://www.google.com/search?q=' + encodeURIComponent(term), '_blank');
        
        window.copyKey = () => { 
            navigator.clipboard.writeText(document.getElementById('currentKeyDisplay').innerText).then(() => {
                showToast("KEY COPIED TO CLIPBOARD");
            }); 
        };

        window.recoverData = () => {
            try {
                const input = document.getElementById('recoverKeyInput').value.trim();
                if (!input) return;
                const parsed = JSON.parse(atob(input));
                appData = parsed; 
                saveData(); 
                window.location.reload(); 
            } catch(e) { 
                showToast("INVALID BACKUP KEY");
            }
        };

        window.calculatePlates = () => {
            const val = parseInt(document.getElementById('targetWeight').value);
            const res = document.getElementById('calcResult');
            const vis = document.getElementById('platesVisual');
            if(!val || val < 45) { res.innerText = "> 45lbs"; vis.innerHTML = ''; return; }
            let weight = (val - 45) / 2;
            let html = '';
            [45, 35, 25, 10, 5, 2.5].forEach(p => {
                while(weight >= p) {
                    weight -= p;
                    let h = (p === 45) ? 'h-24' : (p === 35) ? 'h-20' : (p === 25) ? 'h-16' : (p === 10) ? 'h-12' : (p === 5) ? 'h-8' : 'h-6';
                    let c = (p === 5) ? 'bg-brass' : (p === 2.5) ? 'bg-rust' : 'bg-brand-text';
                    html += `<div class="${h} w-4 ${c} rounded shadow-sm z-10"></div>`;
                }
            });
            res.innerText = "Plates per side";
            vis.innerHTML = `<div class="absolute w-full h-3 bg-brand-line rounded-full top-1/2 -translate-y-1/2"></div><div class="flex items-center gap-1.5 z-10 relative">${html}</div>`;
        };

        function getHistory(exName) {
            const selectedDate = getSelectedDateStr();
            const matchingIds = new Set();
            Object.values(workoutData).forEach(day => { 
                day.AM.concat(day.PM).forEach(ex => { if(ex.name === exName) matchingIds.add(ex.id); });
            });
            return Object.values(appData.workouts)
                .filter(d => (matchingIds.has(d.exerciseId) || (d.exerciseId && d.exerciseId.startsWith('bonus_'))) && d.date !== selectedDate)
                .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
        }

        init();
    </script>
</body>
</html>


